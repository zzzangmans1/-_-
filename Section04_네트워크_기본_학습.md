# 1. 프로토콜
## (1) 개요
1. 시스템 간에 통신하기 위한 규약
2. 프로토콜은 구문, 의미, 타이밍으로 이루어져 있다.

## (2) 프로토콜의 구성요소
1. 구문 : 송수신 데이터 포맷을 의미한다.
2. 의미 : 데이터의 각 항목이 가지는 의미를 의미한다.
3. 타이밍 : 데이터 송수신 동작 방식을 정의하는 것을 의미한다.

# 2. OSI 7 Layer
## (1) 개요
1. 국제 표준화 기구(ISO)에서 제정한 개방형 시스템 간의 상호연결(OSI: Open System Interconnection) 모델
2. 분산된, 이기종 시스템 간의 네트워크 상호호환을 위해 필요한 표준 아키텍처를 정의한 참조모델
3. 기능에 따라 계층적으로 표준화 되어 있다. 어떤 목적을 수행하기 위해서 하나의 큰 프로토콜을 설계하는 것이 아니라 계층적으로 나누어진 여러 프로토콜을 조합하여 그 목적을 수행하는 방식이다. 이러한 접근 방식을 "분할 정복"이라 한다.
4. 계층별로 표준화를 함으로써 상하위 계층 간에 인터페이스만 충족시켜주면 다양한 제조자들에 의한 독자적인 계층별 프로토콜의 구현 및 발전을 이룰 수 있다.

## (2) 계층별 특징
### 1) Pysical Layer (물리 계층, L1)
#### (가) 개요
1. 물리적 장치의 전기적, 전자적 연결에 대한 명세
2. 디지털 데이터를 전기적인, 광학적인 신호로 변환하여 입출력을 담당하는 계층으로 1계층에는 주소 정보가 없다. 따라서 목적지를 인식할 수 없고 전기적인 신호만을 연결된 모든 노드에 전달한다.
3. 물리 계층의 데이터 단위를 **비트**라 한다.

#### (나) 주요 네트워크 장비
1. HUB(허브) : 들어온 신호를 연결된 모든 포트로 전달하는 중계 장치이다. 이러한 허브를 Dummy Hub라고 한다.(2계층 장비는 Switching Hub로 구별)
    * Switching Hub : Dummy Hub는 연결된 모든 노드에게 신호를 전달하는 반면에 Switching Hub는 목적지 주소(2계층 장비이므로 MAC 주소를 의미)를 식별하여 해당 목적지 노드가 연결된 포트로만 신호를 전달하는 장비를 말합니다.
2. REPEATER(리피터) : 감쇠된 전송신호를 새롭게 재생하여 다시 전달하는 재생 중계 장치이다.

#### (다) 허브(Dummy Hub) 환경에서의 스니핑(Sniffing)
1. 더미 허브는 전달받은 패킷을 단순히 연결된 모든 노드로 전송하기 때문에 허브에 연결되어있는 모든 노드는 스니퍼를 통한 스니핑이 용이하다. 단, 네트워크 카드의 기본동작모드가 자신을 목적지 주소로 하는 패킷이 아니면 모두 폐기하기 때문에 패킷을 볼 수 있는 것은 아니다.
2. 네트워크 카드(NIC)의 동작모드를 **무차별 모드(Promiscuous Mode)**로 설정하면 자신이 목적지가 아닌 패킷도 모두 수신하기 때문에 더미 허브 환경에서 손쉽게 스니핑할 수 있다. 일반적으로 스니퍼가 동작할 때 네트워크 카드의 동작모드를 무차별 모드로 설정한다.

### 2) Data Link (데이터 링크 계층, L2)
#### (가) 개요
1. Node-To-Node Delivery, 인접한 노드 간의 신뢰성 있는 프레임 전송을 담당하는 계층이다. 데이터링크 계층은 인접노드 간의 통신이며 최종 목적지 노드에 도달하기 위해서는 각각의 노드 간에 프레임에 대한 주소설정(MAC 주소)이 이루어진다.
2. 목적지 노드를 찾아가기 위해서는 목적지 노드에 대한 물리적인 주소가 필요하며 네트워크 카드(NIC)의 MAC 주소가 해당 역할을 한다.
3. IEEE 802 표준에서는 LAN 상의 데이터링크 계층을 LLC(Logical Link Control) 와 MAC(Media Access Control) 두 개의 하위 계층으로 세분화한다.
    * LLC (Logical Link Control) : 네트워크 계층과의 연결을 담당하는 계층으로 상위 계층으로 안전하고 정상적인 데이터를 전달하기 위해 데이터 오류 검출 및 상위 프로토콜에 대한 타입 확인
    * MAC (Media Accesss Control) : 물리적 계층과의 연결을 담당한느 계층으로 신호변환을 통해 물리적 계층과 연결하고 MAC 주소를 통해 주소를 확인하여 정상적으로 데이터가 송수신되고 있는지 확인
4. 데이터링크 계층의 데이터 단위를 **프레임**이라 한다.
5. 데이터링크 계층의 대표적 프로토콜로 Eternet, TokenRing, FDDI, X.25, Frame Relay 등이 있다.

#### (나) 신뢰성 있는 전송을 위한 기능
1. 신뢰성 있는 전송이란 데이터의 안전한 전송을 보장해준다는 의미로 이러한 기능들을 일반적으로 데이터링크 컨트롤이라 한다.
2. **흐름제어 (Flow Contorl)** : 송신 노드가 수신 노드의 처리 속도를 고려하여 이를 초과하지 않도록 전송을 제어한다. 이러한 흐름제어는 수신 노드가 수신확인응답을 송신 노드에 제공함으로써 흐름제어를 수행하는데 다음 2가지 방식이 있다.
    * **정지-대기 (Stop and Wait)** : 송신 측에서 프레임을 전송한 후 확인응답(ACK)을 받을 때까지 대기하는 방식
    * **슬라이딩 윈도우 (Sliding Window)** : 송신 측에서 수신 측의 수신확인응답을 받기 전에 수신 가능한 범위 내에서 여러 프레임을 전송하는 방식
3. **오류제어 (Error Control)** : 전송 중에 여러 가지 원인(주파수 혼란, 감쇠, 잡음 등)에 의한 오류나 손실 발생 시 이를 해결하기 위한 제어방식이다. 오류제어 방식에는 다음 2가지 방식이 있다.
    * **후진 오류 수정방식 (BEC, Backward Error Correction)** : 송신 측에서 데이터전송 시 오류를 검출할 수 있는 부가 정보를 함께 전송하여 수신 측에서 이를 점검하여 오류 발생 시 재전송을 요청하는 방식으로 이러한 요청을 ARQ(Automatic Repeate Request)라 한다.
    * **전진 오류 수정방식 (FEC, Forward Error Correction)** : 재전송이 불필요한 방식으로 송신 측에서 데이터 송신 시에 오류의 검출 및 수정까지 가능한 부가 정보를 담아서 보내는 방식
4. **회선제어 (Line Control)** : 점-대-점(Point-to-Point) 또는 다중점 회선 구성 방식 과 단방향, 반이중 및 전이중 등의 전송 방식에 따라 사용되는 전송링크에 대한 제어 규범이다.

#### (다) 주요 네트워크 장비
1. L2 Switch
    * 스위치 장비는 내부적으로 MAC Address Table을 가지고 있다. 이 테이블에는 스위치 포트에 연결된 노드의 MAC 정보를 담고 있다. 이 정보를 참조하여 목적지 MAC 주소의 포트에 연결된 노드에게만 패킷을 전송한다.
    * 스위치 환경에서 특정 포트를 모니터링하고자 한다면 모니터링 포트 또는 네트워크 트래픽을 모니터링할 수 있는 탭 장비를 통해 패킷을 복제해서 트래픽 분석 장비로 전달한다.
    * 스위치 환경에서는 기본적으로 목적지로만 패킷을 전송하기 때문에 스니핑이 불가능하다. 이러한 환경에서 스니핑을 하기 위해서는 스위치 재밍, ARP 스푸핑, ARP 리다이렉트, ICMP 리다이렉트, 스위치의 SPAN/Monitoring Port 이용 등이 있다.
2. Bridge
    * 물리적으로 떨어진 동일한 LAN을 연결해주는 장비

#### (라) 스위치 환경에서의 스니핑 공격 기법
1. **스위치 재밍(Switch Jamming)/MAC Flooding 공격**
   * 스위치 MAC Address Table의 버퍼를 오버플로우 시켜서 스위치가 허브처럼 동작하게 강제적으로 만드는 기법을 말한다. 스위치는 Fail Safe/Open 정책을 따르는 장비이므로 장애가 발생하면 더미 허브처럼 연결된 모든 노드에 패킷을 전송한다.
   * MAC Address Table을 채우기 위해(오버플로우 시키기 위해) Source MAC 주소를 계속 변경하면서 패킷을 지속적으로 전송하는 방식을 사용한다.
2. **ARP 스푸핑 공격**
   * **공격자가 특정 호스트의 MAC 주소를 자신의 MAC 주소로 위조한 ARP Reply 패킷을 만들어 희생자에게 지속적으로 전송하면 희생자의 ARP Cache Table에 특정 호스트의 MAC 정보가 공격자의 MAC 정보로 변경된다.** 이를 통해서 희생자로부터 특정 호스트로 나가는 패킷을 공격자로 향하도록 하여 스니핑하는 기법이다.
   * 희생자와 특정 호스트 간의 송수신 패킷을 모두 스니핑하기 위해서는 희생자와 특정 호스트 모두 ARP 스푸핑을 수행한다.
   * **희생자들이 스누핑을 인식하지 못하고 정상적인 통신이 될 수 있도록 IP Forward 기능을 활성화**한다.
      * IP Forwarding 기능 : 일반적인 호스트 설정의 경우 자신을 목적지 주소로 하지 않는 IP 패킷을 수신한 경우 모두 폐기하지만 IP Forward 기능을 활성화하면 라우터처럼 동작하여 자신이 목적지가 아닌 IP 패킷에 대해서는 라우팅 테이블을 참조하여 해당 목적지로 전송하게 됩니다.
3. **ARP 리다이렉트 공격**
   * **ARP 스푸핑 공격의 일종으로 공격자가 자신이 라우터/게이트웨이인 것처럼 MAC 주소를 위조하여 ARP Reply 패킷을 대상 네트워크에 지속적으로 브로드캐스트하면 해당 로컬 네트워크의 모든 호스트의 ARP Cache Table에 라우터/게이트웨이의 MAC 정보가 공격자의 MAC 정보로 변경**이 된다. 이를 통해 호스트에서 라우터로 나가는 패킷을 공격자가 스니핑하는 기법이다.
   * 희생자들이 스니핑을 인식하지 못하고 정상적인 통신이 될 수 있도록 IP Forward 기능을 활성화한다.
4. **ICMP 리다이렉트 공격**
   * **ICMP Redirection 메시지는 호스트-라우터 또는 라우터 간에 라우팅 경로를 재설정하기 위해 전송하는 메시지**이다. 공격자가 이를 악용하여 특정 IP 또는 IP 대역으로 나가는 패킷의 라우팅 경로를 **자신의 주소로 위조한 ICMP Redirect 메시지를 생성하여 희생자에게 전송함으로써 희생자의 라우팅 테이블을 변조하여 패킷을 스니핑하는 공격**기법이다.
   * 희생자들이 스니핑을 인식하지 못하고 정상적인 통신이 될 수 있도록 IP Forward 기능을 활성화한다.
5. **스위치의 SPAN (Switch Port ANalyzer)/Port Mirroring 기능 이용**
   * 스위치의 SPAN/Port Mirroring 기능은 스위치를 통과하는 모든 트래픽을 볼 수 있는 기능으로 특정 포트에 분석 장비를 접속하고 다른 포트의 트래픽을 분석 장비로 자동 복사해주는 기술이다.
   * 관리적인 목적으로 사용하지만, 공격자가 물리적으로 해당 포트에 접근할 수 있다면 손쉽게 패킷을 스니핑 할 수 있다.

### 3) Network Layer (네트워크 계층, L3)
#### (가) 개요
1. End-To-End Delivery, End 노드(종단노드) 간의 라우팅을 담당하는 계층으로 Host-To-Host Delivery라고도 한다.
2. 라우팅이란 라우팅 알고리즘에 의해 목적지로 전송하기 위한 최적의 경로를 설정하고 패킷을 교환하는 기능을 제공하는 것을 말한다.
3. 최종 목적지 노드를 찾아가기 위해서는 노드에 대한 논리적인 주소가 필요한데 TCP/IP 프로토콜에서는 IP 주소가 이 역할을 한다.
4. 네트워크 계층의 데이터 단위를 **패킷**이라 한다.
5. 대표적으로 IP(TCP/IP), IPX(Novel Netware) 등이 있다.

#### (나) 주요 네트워크 장비
1. 라우터 / L3 Switch
   * 라우팅(최적의 경로를 선정해서 패킷을 포워딩하는 기능)을 담당하는 장비
   * 데이터 링크 계층의 브로드캐스트와 멀티캐스트를 포워딩 하지 않으며, 서로 다른 VLAN간에 통신을 가능하게 하고, 기본적인 보안 기능과 QoS관련 기능을 지원하는 장비

### 4) Transport Layer (전송 계층, L4)
#### (가) 개요
1. End-To-End Reliable Delivery, End 노드 간의 신뢰성 있는 데이터전송을 담당하는 계층이다. 좀 더 구체적으로 말하면 각 End 노드의 해당 Process 간 신뢰성 있는 데이터전송을 담당하는 계층이다. (Process-To-Process Communication)
2. 목적지 Node(Process)를 찾아가기 위해서는 Process를 식별하기 위한 논리적인 주소가 필요하며 TCP/IP 프로토콜에서는 Port Address가 이 역할을 한다.
3. 전송 계층의 데이터 단위를 **세그먼트**라 한다.
4. 대표적 프로토콜로 TCP/IP의 TCP, UDP, SCTP와 Novel Netware의 SPX 등이 있다.

#### (나) 신뢰성 있는 데이터 전송을 보장하기 위한 기능
1. **분할 (Segmentation)과 재조합 (Reassembly)**
   * 조건에 따라 원본 데이터를 전송 가능한 세그먼트 단위로 분할하여 전송하면 목적지에서는 이를 재조합하여 원본 데이터를 복원한다.
2. **연결제어 (Connection Control)**
   * 연결지향(TCP) 과 비연결지향(UDP) 방식을 제공한다.
3. **흐름제어 (Flow Control)**
   * 흐름제어를 한다는 것은 상호 간에 수신할 수 있는 만큼만 전송해서 데이터의 손실이 발생하지 않도록 하는 제어방식을 말한다.
   * 종단 노드 간 흐름제어를 수행한다. **데이터링크 계층은 바로 인접한 노드 간에 흐름제어**를 했다면 **전송 계층에서는 양 종단노드 간에 흐름제어를 수행하므로 그 범위가 넓다**.
4. **오류제어 (Error Control)**
   * 종단노드 간 전송 중 오류 발생 시 이를 교정한다.
5. **혼잡제어 (Congestion Contorl)**
   * 네트워크 혼잡도를 계산하여 전송량을 제어한다.

#### (다) 주요 네트워크 장비
1. L4 Switch : SLB (Server Load Balancing) 즉 서버 트래픽 부하분산과 Failover 기능을 제공한다.
   * **장애 조치 (Failover)** : 시스템에 장애가 발생했을 때 예비 시스템으로 자동 전환되는 기능을 말한다.
  
### 5) Session Layer (세션 계층, L5)
#### (가) 개요
1. Application간 논리적인 연결인 세션의 생성, 관리 및 종료를 담당하는 계층

### 6) Presentation Layer (표현 계층, L6)
#### (가) 개요
1. 데이터 표현방식 변환을 담당하는 계층
2. 인코딩/디코딩, 압축/압축해제, 암호화/복호화 등을 담당한다.

### 7) Application Layer (응용 계층, L7)
#### (가) 개요
1. 사용자가 네트워크에 접근할 수 있는 인터페이스를 담당하는 계층
2. 네트워크 서버/클라이언트 프로그램
3. 응용 계층의 데이터 단위를 **데이터**라고 한다.
   * 일반적으로 5,6,7 계층 데이터 단위를 모두 데이터라 한다.

# 3. OSI 모델 데이터 교환 방식
### 1) Encapsulation(캡슐화)/Decapsulation(역캡슐화)
1. 상위 계층의 데이터가 하위계층으로 보내지면, 하위 계층 프로토콜은 자신의 기능 수행을 위해 필요한 부가 정보(헤더)를 추가해서 새롭게 전송 메시지를 완성한다. 이를 캡슐화라고 한다.
2. 수신 측에서는 상위 계층으로 데이터를 보낼 때 해당 계층의 헤더 정보를 확인한 후 제거하고 상위 계층으로 데이터를 보낸다. 이를 역캡슐화 라고 한다.

### 2) Multiplexing(다중화)/Demultiplexing(역다중화)
1. 다중화는 하나의 기능(매체)을 여러 영역에서 동시에 사용하는 기법을 말한다. 상위 계층의 여러 프로토콜이 하위 계층의 하나의 프로토콜을 이용하여 데이터를 전달하는 방식으로 수신 측에서 상위 프로토콜을 구별할 수 있도록 프로토콜 식별자 정보를 헤더에 추가한다.
2. 역다중화는 공유하는 기능(매체)으로부터 개별 영역으로 분할하는 기법을 의미한다. 하위계층의 프로토콜이 여러 상위 계층 프로토콜 중 하나를 식별하여 데이터를 전달하는 방식으로 이를 위해서는 상위 프로토콜을 구별하기 위한 프로토콜 식별자 정보(다중화 시에 헤더에 설정된 정보)를 이용한다.

# 4. TCP/IP 프로토콜
### 1) Application Layer (응용 계층)
#### (가) 개요
1. 네트워크 서버/클라이언트 프로그램을 담당하는 계층
2. 사용자와의 인터페이스를 담당하는 계층

#### (나) 주요 프로토콜
1. HTTP(80/tcp) : Hyper-Text Transfer Protocol
2. FTP(20/21/tcp) : File Transfer Protocol, 데이터 포트(20), 제어 포트(21)
3. SSH(22/tcp) : Secure Shell, 암호화된 원격 터미널 접속 프로토콜
4. SFTP(22/tcp) : SSH File Transfer Protocol, SSH를 이용한 암호화된 파일 송수신 프로토콜
5. TELNET(23/tcp) : TELe NETwork, 암호화하지 않은 원격 터미널 접속 프로토콜
6. SMTP(25/tcp) : Simple Mail Transfer Protocol, 메일 전송용 프로토콜
7. POP3(110/tcp) : Post Office Protocol Version3, 메일 수신용 프로토콜
8. IMAP(143/tcp) : Internet Message Access Protocol, 메일 수신용 프로토콜
9. DNS(53/tcp,udp) : Domain Name System, 도메인명에 대한 호스트 정보를 제공해주는 프로토콜
10. DHCP(67,68/udp) : Dynamic Host Configuration Protocol, 서버(67), 클라이언트(68), 동적으로 호스트 네트워크 설정을 제공해주는 프로토콜
11. TFTP(69/udp) : Trivial FTP, 단순 파일 송수신 프로토콜
12. SNMP(161/udp) : Simple Network Management Protocol, 네트워크 관리 프로토콜

### 2) Transport Layer(전송 계층)
#### (가) 개요
1. Process-To-Process Communication, 프로세스 간 신뢰성 있는 데이터전송을 담당하는 계층으로 신뢰성 있는 전송이란 전송 중에 발생하는 오류, 누락 및 흐름제어, 혼잡제어 등을 적절히 수행하여 데이터의 안전한 전송을 보장함을 말한다.
2. 프로세스를 식별하기 위한 논리적인 주소로 Port(16bit) 주소를 사용한다.

#### (나) 주요 프로토콜
1. TCP(Transmission Control Porotocl) : 신뢰성 있는 연결지향 프로토콜(스트림 기반 전송)
2. UDP(User Datagram Protocol) : 비신뢰적인 비연결형 프로토콜(데이터그램 기반 전송)
3. SCTP(Stream Control Protocol) : TCP와 UDP의 조합형

### 3) Internet Layer(인터넷 계층)
#### (가) 개요
1. Host-To-Host Communication, 호스트 간의 라우팅을 담당하는 계층
2. 호스트를 식별하기 위한 논리적은 주소로 IP(IPv4:32bit, IPv6:128bit) 주소를 사용한다.

#### (나) 주요 프로토콜
1. IP(Internet Protocol) : 비신뢰적인 비연결형 데이터그램 프로토콜
2. ICMP(Internet Control Message Protocol) : 에러 및 상태진단 메시지 프로토콜
3. IGMP(Internet Group Management Protocol) : 멀티캐스트용 프로토콜
4. ARP(Address Resolution Protocl) : 주소변환(논리주소(IP) -> 물리주소(MAC)) 프로토콜
5. RARP(Reverse Address Resolution Protocol) : 역주소변환(물리주소(MAC) -> 논리주소(IP)) 프로토콜

### 4) Network Interface Layer(네트워크 인터페이스 계층)
#### (가) 개요
1. Node-To-Node Delivery, 인접한 노드 간에 신뢰성 있는 데이터전송을 담당하는 계층
2. Node를 식별하기 위한 물리적인 주소로 MAC(48bit) 주소를 사용한다. 물리적 MAC 주소는 상위 24비트와 하위 24비트로 이루어져 있으며 상위 24비트는 제조사(벤더) 식별코드이고 하위 24비트는 제조사가 할당한 일련변호를 의미한다.

#### (나) 주요 프로토콜
1. LAN(Local Area Network) 프로토콜 : Ethernet, TokenRing, FDDI 등
2. WAN(Wide Area Network) 프로토콜 : X.25, Frame Relay, PPP, SLIP 등

# 5. ARP/RARP 프로토콜(TCP/IP 인터넷 계층)
### 1) ARP 및 RARP 프로토콜 특징
1. 논리적인 주소와 물리적인 주소 사이의 변환을 담당하는 프로토콜
2. ARP(Address Resolution Protocol) : 논리적인 IP 주소를 물리적인 MAC 주소로 변환해주는 역할을 하는 프로토콜
3. RARP(Reverse ARP)
   * 물리적인 MAC 주소를 논리적인 IP 주소로 변환해주는 역할을 하는 프로토콜
   * 일반적으로 IP 주소는 시스템의 하드디스크 내 설정 파일에 저장되어 있지만 하드디스크가 없는 터미널의 경우에 초기 가동될 때 자신의 MAC 주소를 담아 RARP 요청을 만들어 자신의 IP 주소 정보를 받아오게 된다. MAC에 해당하는 IP 주소 정보를 관리하는 RARP 서버가 구성되어 있어야 한다.
  
### 2) ARP 동작방식
1. **최초 상대방의 물리적인 주소를 알지 못하기 때문에(논리적인 IP 주소만 알고 있는 상태) ARP 요청 메시지를 만들어 브로드캐스트**한다.
   * ARP 요청 메시지를 캡슐화한 이더넷 프레임의 목적지 MAC 주소를 살펴보면 브로드캐스트 주소인 ```FF:FF:FF:FF:FF:FF``` 로 전송한다.
2. **Target 호스트에서는 ARP 응답 메시지를 만들어서 응답**한다. **응답메시지에는 Target 호스트의 MAC 주소 정보가 담겨있으며 응답자는 요청자의 MAC 주소를 알고 있으므로 유니캐스트 방식으로 응답**한다. Target이 아닌 호스트들은 수신한 브로드캐스트 요청 메시지를 폐기한다.
   * ARP 응답메시지를 캡슐화한 이더넷 프레임의 목적지 MAC 주소를 살펴보면 요청 메시지를 보낸 호스트의 MAC 주소로 설정된 것을 확인할 수 있다.
3. 각 시스템은 ARP Cache가 있고 Cache에 이 정보를 보관해 둔다. 물론 일정 시간 경과 후에는 삭제된다.

### 3) RARP 동작방식
1. **최초 자신의 논리적인 IP 주소를 알지 못하기 때문에(물리적인 MAC 주소만 알고 있는 상태) 자신의 MAC 정보를 담고 있는 RARP 요청 메시지를 만들어서 브로드캐스트**한다.
2. **RARP Server는 요청자의 IP 주소 정보를 담은 RARP 응답 메시지를 만들어 요청자의 MAC 주소로 유니캐스트 방식으로 응답**을 준다.

### 4) ARP cache table 살펴보기
#### (가) 개요
1. ARP 요청을 통해 알아낸 MAC 정보는 OS에 따라 다르지만 통상 1~2분 정도 메모리에 저장한다.
2. arp -a 명령을 통해 ARP cache table을 살펴보면 타입이 dynamic 또는 static으로 지정이 되어 있다. dynamic으로 된 것은 arp에 의해 동적으로 설정된 것으로 일정 시간 동안 유지된다. static으로 된 것은 관리자에 의해 정적으로 설정된 것으로 관리자가 삭제하거나 시스템이 종료하기 전까지 지속적으로 유지된다.

#### (나) 관련 명령어
1. arp -a : 캐시 내용 보기
   * 윈도우의 경우 MAC 주소 구분자 "-" 사용
   * 리눅스의 경우 MAC 주소 구분자 ":" 사용
2. arp -d : 캐시 내용 삭제
   * 윈도우의 경우 arp cache에 저장된 모든 내용 삭제
   * 리눅스의 경우 IP를 명시해야 하고 삭제된 항목은 일정 시간 <incomplete> 상태로 보인 후 삭제된다.
3. arp -s : 캐시 정적 설정
   * 윈도우의 경우 static으로 설정된 정보는 시스템 종료 시까지 유지된다.
   * 리눅스의 경우 PERM으로 설정된 정보는 시스템 종료 시까지 유지된다.

### 5) ARP Spoofing 공격(ARP Cache Poisoning)
#### (가) 개요
1. 공격자가 희생자의 MAC 주소를 자신의 MAC 주소로 위조한 ARP Reply를 만들어 희생자에게 지속적으로 전송하면 희생자 ARP Cache Table의 MAC 정보가 공격자의 MAC 정보로 지속적으로 변경된다. 이를 통해서 희생자 간의 송수신 패킷을 공격자가 스니핑하는 기법이다.
2. 공격자는 희생자간에 정상적인 통신이 이루어질 수 있도록(스니핑을 눈치채지 못하도록) IP Forward 기능을 활성화한다.
3. **일반적으로 희생자 ARP Cache의 Gateway(Router) 주소를 공격자 MAC 주소로 변조시켜서 외부로 나가는 데이터를 스니핑하는데 이를 특별히 ARP Redirect 공격**이라 한다.
4. **ARP Spoofing은 2계층 주소인 MAC 주소를 속여서 트래픽을 스니핑하는 것이므로 2계층에서 동작하게 된다. 2계층 주소는 서로 다른 네트워크로 라우팅되지 않기 때문에 공격 대상도 동일 네트워크 대역에 있어**야 한다.

#### (나) 실습
1. 희생자PC ARP Cache Table 변조
   * 공격 전 : 첫 번째 "arp -a" 명령 결과를 살펴보면 희생자PC의 MAC 주소가 정상적으로 설정되어 있음을 확인할 수 있다.
   * 공격 후 : 두 번째 "arp -a" 명령 결과를 살펴보면 희생자PC의 MAC 주소가 공격자PC의 MAC 주소와 동일하게 설정되어 있음을 확인할 수 있다. 즉 공격자에 의해 조작된 arp reply 패킷에 의해 cache 정보가 변조되었음을 알 수 있다.
   * 희생자PC에서 패킷 캡처한 결과를 살펴보면 공격자에 의해 주기적으로 arp reply 패킷이 발생하고 있으며 arp 프로토콜의 sender MAC과 IP를 보면 희생자 PC의 MAC 주소가 공격자의 MAC 주소로 조작되어 있다.
2. 희생자 PC ARP Cache Table 변조
   * 희생자PC와 동일하게 공격자PC에 의해 Cache 정보가 변조되었음을 확인할 수 있다.

#### (다) 대응방법
1. ARP 요청 및 응답 과정에서 별도의 인증과정이 없는 ARP 프로토콜 자체의 취약점을 이용한 공격이기 때문에 완벽한 방어는 없다. 일반적인 대응 방법은 ARP 캐시를 정적으로 설정하여 ARP 응답을 수신해도 캐시 정보를 갱신하지 않도록 한다.
2. 캐시 정보는 시스템 종료 시 삭제되므로 시스템 기동 시마다 ARP 캐시를 정적으로 구성해 주어야 한다.
3. 네트워크상의 ARP 트래픽을 실시간으로 모니터링하는 프로그램(ARP Watch 등)을 이용하여 IP와 MAC 주소의 매핑을 감시, 변경 발생 시 즉시 확인하도록 한다.

### 6) GARP (Gratuitous ARP)
#### (가) 개요
1. Gratuitous란 "불필요한"이란 의미이다. GARP는 별도의 프로토콜이 아니고 Sender IP와 Target IP가 동일한 ARP 요청을 GARP라고 한다.
2. 장비가 ARP 요청 브로드캐스트를 통해 다른 장비에게 네트워크에 있는 자신의 존재를 알리는 목적으로 사용되는 패킷이다. 이 패킷을 수신한 장비는 자신의 ARP Cache에 해당 정보가 있다면 이를 갱신한다.
3. 자신의 MAC 정보를 동일 네트워크상의 다른 장비들에 알려 ARP Cache를 갱신하도록 하는 목적이다.

#### (나) 목적
1. IP 충돌 감지
   * IP 충돌 여부를 GARP를 통해 검색한다. 즉 자신과 동일한 IP가 설정된 호스트가 있다면 해당 호스트로부터 ARP 응답이 오기 때문에 충돌 여부를 확인할 수 있다.
   * 일반적으로 호스트 IP를 변경하거나 재부팅 시에 GARP 패킷이 생성된다.
2. 상대방의 ARP Cache 정보 갱신
   * GARP 메시지를 수신한 쪽에서는 자신의 ARP Cache에 Sender IP 정보를 갱신한다.
   * 이 부분이 취약점이 될 수 있다. 즉 상대방을 인증하지 않고 Cache 정보를 갱신하게 되므로 악의적인 목적의 공격자에 의해 MAC 정보가 위변조될 수 있다.

# 6. IP(IPv4) 프로토콜
### 1) 개요
1. 비연결형 프로토콜로 연결 상태를 유지하지 않기 때문에 패킷 전송 순서를 보장하지 않는다.
2. 비신뢰적 프로토콜로 신뢰성 있는 통신을 보장하지 않는다.
3. IP는 목적지 주소를 기반으로 라우팅을 담당하는 인터넷 계층의 대표 프로토콜이다. 라우팅은 라우팅 알고리즘을 통해 최적의 경로를 선정하여 목적지를 찾아가는 것을 말한다.

### 2) IP 프로토콜 구조
1. VER(4 bits) : IP의 버전 정보, 일반적으로 IPv4 사용
2. HLEN(4 bits) : 헤더 길이, 4 bytes 단위로 표현
3. Service type(8 bits) : 서비스 품질(QoS)을 위한 용도이지만 현재 사용하지 않음
4. Total length(16 bits) : 헤더부와 데이터부를 포함한 전체 IP Packet의 길이
5. **Identification(16 bits)** : 단편화/재조합 관련 필드
   * IP 데이터그램을 여러 조각으로 분할하는 것을 단편화라 하고 분할된 단편들을 조합하여 원본 IP 데이터그램을 완성하는 것을 재조합이라 한다.
   * 단편화 전 원본 IP 데이터그램을 식별하기 위한 ID
6. **Flags(3 bits)** : 단편화/재조합 관련 필드
   * 첫 번째 비트 : 사용 안 함(예약)
   * 두 번째 비트 : Don`t fragment bit(1 설정 시 패킷을 단편화하지 말라는 의미)
   * 세 번째 비트 : More fragment bit(1 설정 시 재조합할 단편이 남아 있다는 의미이고 0 설정 시 단편이 더 이상 없다는 의미이다.)
7. **Fragmentation offset(13 bitsx)** : 단편화/재조합 관련 필드
   * IP의 특성상 원본 IP 데이터그램의 단편들이 순서대로 전송되는 것이 아니므로 이를 순서대로 조합하기 위한 현재 단편의 상대위치를 저장한 필드
   * 8 bytes 단위로 표현한다.
8. **Time to live(8 bits)** : IP 패킷의 생존시간을 지정하는 필드
   * 최초에 초 단위로 생존시간을 명시할 의도였으나 시간 측정의 어려움으로 인해 라우터/L3스위치 통과 횟수(hop count라고 함)로 그 의미가 바뀜
   * 패킷이 라우터/L3스위치에 도착하면 TTL값을 1 감소시키고 그 값이 0이 되면 해당 패킷을 폐기한다.
   * TTL을 설정하는 목적은 라우터/L3스위치를 통해 패킷 라우팅을 하던 중 무한 루핑이 발생하여 목적지에 도달할 수 없는 패킷이 무한히 생존하여 네트워크 대역만 차지하는 상태를 방지하기 위함이다.
   * 일반적으로 Linux는 64, Windows는 128, Unix는 255를 설정한다. 운영체제별로 부여하는 기본 TTL값이 다르기 때문에 해당 필드를 "OS 핑거프린트" 목적으로 사용할 수 있다.
9. Protocol(8 bits) : 상위 프로토콜을 식별하기 위한 프로토콜 번호를 저장하는 필드
   * 상위 프로토콜과 다중화, 역다중화를 식별값으로 ICMP(1), TCP(6), UDP(17) 등이 있다.
10. Header checksum(16 bits) : 데이터부를 제외한 헤더 부분의 오류 검사값
11. Source IP address(32 bits) : 출발지 IP 주소
12. Destination IP address(32 bits) : 목적지 IP 주소
13. 주요 IP 옵션 헤더
   * Loose Source Route : Source Route는 라우팅 경로를 라우터/L3 스위치가 아닌 출발지에서 지정하는 옵션으로 느슨한(Loose) 소스 라우팅은 경우에 따라 다른 경로로 라우팅할 수 있다.
   * Strict Source Route : 엄격한(Strict) 소스 라우팅은 출발지에서 지정한 경로로 무조건 라우팅하는 옵션이다.

### 3) IP 단편화(Fragmentation)
#### (가) 개요
1. IP 패킷/데이터그램은 MTU에 따른 단편화가 발생한다.
   * MTU(Maximum Transmission Unit) : 물리적인 네트워크 프로토콜 프레임의 데이터부의 최대 크기를 말한다.
   * 물리적인 네트워크 프로토콜들은 각자 물리적인 특성에 맞게 정의된 MTU를 가진다. IP 패킷이 LAN 또는 WAN의 다양한 프로토콜의 상위 프로토콜로 사용할 수 있는 이유가 이 단편화를 이용한 패킷 크기 조절이 가능하기 때문이다. 가장 많이 사용하는 이더넷의 경우 MTU는 1,500바이트이다.
   * IP 패킷이 프레임으로 캡슐화되기 때문에 MTU를 초과하는 크기가 될 수 없다. 예를 들어 대표적인 이더넷의 경우 MTU가 1,500바이트이기 때문에 IP 패킷이 이보다 크다면 1,500바이트 이하의 크기로 단편화하여 전송해야 한다.
2. 단편화는 최초 출발지뿐만이 아니라 라우터/L3스위치 중계 구간의 MTU에 따라 추가적으로 발생하지만, 단편화된 패킷은 통신 효율을 위해 중계 구간의 MTU가 달라진다고 해도 재조합되지 않으며 최종 목적지에만 재조합된다.

#### (나) 동작방식
1. 첫 번째 단편을 살펴보면 데이터부는 1480byte(IP 헤더 20byte를 포함하여 1500byte)이고 두 번째 단편이 있기 때문에 "More fragments bit(3번째 Flag)"가 1이고 Offset은 첫 번째 단편이기 때문에 0으로 설정되어 있다. 모든 단편이 동일한 원본 IP 데이터그램의 단편이기 때문에 단편 ID가 22666으로 동일하다.
2. 두 번째 단편을 살펴보면 데이터부는 1480byte이고 세 번째 단편이 있기 때문에 "More fragments bit(3번째 Flag)"가 1이고 두 번째 단편은 첫 번째 단편 다음에 위치하기 때문에 1480으로 Offset이 설정된다.
3. 세 번째 단편을 살펴보면 데이터부는 48byte이고 마지막 단편이기 때문에 "More fragments bit(3번째 Flag)"가 0이고 세 번째 단편은 두 번째 단편 다음에 위치하기 때문에 2960이 Offset으로 설정되어 있다.
4. tcpdump의 IP 단편화 관련 출력 형식은 다음과 같다.
```
(frag:"단편 ID":"단편의 크기(IP 헤더 제외)"@"오프셋"+)
+ 있음 : 추가 단편 있음(More Fragments bit : 1)
- 없음 : 마지막 단편(More Fragments bit : 0)
```

### 4) IP 라우팅
#### (가) 라우팅 규칙
1. 첫째로 목적지 주소가 자신과 동일한 네트워크에 있다면 직접 전송한다.
2. 둘째로 목적지 주소가 자신과 동일한 네트워크에 속하지 않는다면 직접 전송이 불가하기 때문에 1차 경유지 주소를 라우팅 테이블을 참조하여 찾는다.
   * 라우팅 테이블은 임의의 목적지로 가기 위한 경로 정보를 저장하고 있는 자료구조이다. "netstat -rn" 명령을 통해 호스트의 라우팅 테이블 정보를 확인할 수 있다.
3. 셋째로 목적지 주소와 자신의 주소가 서로 동일한 경우 목적지가 자신이므로 상위 계층으로 데이터를 전달한다.

#### (나) 라우팅 테이블 검색 방식 및 우선순위
1. 검색 방식 : IP 패킷의 목적지 IP와 라우팅 테이블의 netmask/genmask를 bit and(&) 연산 수행 후 라우팅 테이블의 destination 필드와 비교, 일치하는 경로를 선택하여 패킷을 전송한다.
   * 패킷의 목적지 IP와 netmask/genmask간에 bit and 연산을 한다는 의미는 목적지 IP에서 네트워크 ID 부분만을 추출하기 위한 과정이다.
2. 검색 우선순위
   * 먼저 목적지 호스트 주소와 일치하는 경로를 찾는다.
   * 목적지 호스트 주소와 일치하는 경로가 없으면 목적지 네트워크 주소와 일치하는 경로를 찾는다.
   * 일치하는 경로가 없으면 default gateway(0.0.0.0)로 보낸다.

#### (다) 실습
1. 라우팅 테이블 설정 일부(netstat -rn 명령)
   * Dstination : 목적지 호스트 또는 네트워크 주소
   * Gateway : 목적지로 전송하기 위한 Gateway 주소
   * Genmask : 범용 목적의 마스크로 다음과 같은 역할을 한다.
      * 목적지 Host를 식별하기 위한 마스크 : 255.255.255.255
      * 목적지 Network를 식별하기 위한 마스크 : 넷마스크를 의미
      * default gateway를 식별하기 위한 마스크 : 0.0.0.0
   * Flags : 해당 경로에 대한 상태정보 플래그
      * U(route is Up) : 경로가 활성화되어 있음
      * G(use Gateway) : gateway를 사용함
      * H(target is a Host) : 목적지가 호스트를 의미
2. 라우팅 경로 계산 I : 10.0.96.100 목적지로 패킷 전송 시 gateway 주소
   * 목적지 주소(10.0.96.100)와 첫 번째 행의 Genmask(255.255.255.255) 간에 bit and 연산 수행
   * 연산 결과(10.0.96.100)와 해당 Destination 주소(10.0.96.100)가 일치하므로 해당 경로의 Gateway(10.0.160.1)로 전송
3. 라우팅 경로 계산 II : 10.0.122.100 목적지로 패킷 전송 시 gateway 주소
   * 목적지 주소(10.0.122.100)와 세 번째 행의 Genmask(255.255.192.0) 간에 bit and 연산 수행
   * 연산 결과(10.0.64.0)와 해당 Destination 주소(10.0.64.0)가 일치하므로 해당 경로의 Gateway(10.0.160.3)로 전송
4. 라우팅 경로 계산 III : 10.0.192.100 목적지로 패킷 전송 시 gateway 주소
   * 목적지 주소(10.0.192.100)와 모든 행의 Genmask 간에 bit and 연산 수행 결과 일치하는 Destination 주소가 없으므로 default gateway(10.0.160.5)로 패킷 전송

### 5) IP Spoofing
#### (가) 개요
1. IP 스푸핑은 IP를 속이고 통신하는 공격으로 1995년 '캐빈 미트닉'이 이를 이용하여 실제 해킹을 시도함으로써 널리 알려진 공격방식이다.
2. 시스템 간의 트러스트 관계를 이용, 트러스트 관계가 맺어진 서버와 클라이언트를 확인한 후 신뢰 관계가 있는 클라이언트를 연결 불가능한 상태로 만들고 공격자가 클라이언트의 IP로 위조하여 서버에 접속하는 공격방식이다.
   * 트러스트 관계 설정은 아이디, 패스워드 기반의 로그인이 아닌 신뢰 관계에 있는 IP를 등록하여 해당 IP로 접근하는 것을 허용해주는 방식이다. 즉 IP 주소로 인증하고 로그인 없이 접속할 수 있도록 해주는 방식이다.
   * 트러스트 설정은 다수의 시스템을 관리하는 관리자의 입장에서 아이디와 패스워드를 관리해야 하는 어려움을 해결하고 접속과정에서 아이디, 패스워드가 스니핑되는 위험성을 차단하지만, IP 스푸핑에는 매우 취약하기 때문에 보안상 사용하지 않는 것을 권장한다.

#### (나) 실습(리눅스 환경)
1. 트러스트 설정
   * 유닉스, 리눅스 시스템에서 트러스트 관계 설정 파일로 /etc/hosts.equiv와 $HOME/.rhost 파일이 있다. hosts.equiv 파일은 시스템 전체에 영향을 주는 파일이고 .rhost 파일은 사용자별로 설정하는 파일이다.
   * 설정 방식은 다음과 같다.
|레코드 형식|의미|
|-|-|
|host_name|해당 호스트(IP 또는 호스트명)의 접근 허용|
|host_name user_name|해당 호스트에 해당 사용자로 접근 허용|
|+|모든 호스트의 접근을 허용(계정은 아이디, 패스워드 인증 필요)|
|+ user_name|모든 호스트의 해당 사용자로 접근 허용|
|-host_name|해당 호스트의 접근 차단|
|host_name -username|해당 호스트에서 해당 사용자만 접근 차단|
|+ @group|모든 호스트에서 해당 group 사용자로 접근 허용|
   * 설정 방식을 보면, 앞에 있는 것이 호스트명, 띄어쓰기 후 나오는 것이 사용자명(계정명)이다. +는 모두 허용한다는 의미이고 -(호스트명 또는 계정명)는 차단한다는 의미이다.
   * 만약 "+ +"로 설정한다면 모든 호스트에 대해서 모든 계정을 신뢰한다는 의미이므로 매우 취약한 설정이다.
2. rlogin 서비스 활성화
   * r 계열 서비스(rlogin, rsh, rexec 등)는 인증 없이 신뢰 관계에 있는 시스템들의 원격 접속을 허용해주는 서비스들이다. rlogin의 경우 telnet과 유사하지만, 인증 없이 접속할 수 있다.
   * xinetd 데몬의 rlogin 서비스를 활성화한 후 xinetd 데몬을 재기동한다. netstat 명령으로 소켓 상태를 확인해보면 513/tcp(login 서비스) 포트가 리슨 상태에 있는 것을 확인할 수 있다.
3. rlogin 클라이언트 명령을 통한 원격 접속
   * 원격 클라이언트에서 "rlogin 서버IP" 명령을 통해 접속하면 아이디, 패스워드 확인 없이 바로 연결되는 것을 확인할 수 있다.
4. 공격자는 신뢰 관계에 있는 클라이언트를 사용 불능 상태로 만든 후 해당 클라이언트의 IP로 위조하여 서버에 접속할 수 있다.

#### (다) 대응책
1. 시스템 간 트러스트 설정을 사용하지 않는다.
2. 반드시 사용해야 할 경우에는 트러스트된 시스템의 MAC 주소를 정적으로 구성하여 단순히 IP만을 위조한 접속을 차단한다.

#### (라) $HOME/.rhosts, hosts.equiv 사용금지(시스템 취약점 분석,평가 항목)
1. 개요
   * r 계열 서비스(rlogin, rsh, rexec 등)를 통한 원격 접속은 보안상 매우 취약하여 서비스 포트가 열려있을 경우 중요 정보 유출 등 침해사고의 원인이 될 수 있다. 따라서 r 계열 서비스를 허용하지 않는다.
   * 만약 불가피하게 사용할 경우에는 트러스트 관계 설정 파일인 $HOME/.rhosts, hosts.equiv에 적절한 보안 조치를 해야 한다.
2. 보안조치
   * /etc/hosts.equiv 및 $HOME/.rhosts 파일 소유자를 root 또는 해당 계정으로 변경한다.
      * (예시) ```chown root /etc/hosts.equiv```
   * /etc/hosts.equiv 및 $HOME/.rhosts 파일 권한을 600 이하로 변경한다.
      * (예시) ```chmod 600 /etc/hosts.equiv```
   * /etc/hosts.equiv 및 $HOME/.rhosts 파일에서 "+"를 제거하고 반드시 필요한 호스트 및 계정만 등록한다.
  
### 6) IPv6 살펴보기
#### (가) 개요
1. IPv6는 IPv4 주소가 고갈되는 문제를 해결하기 위하여 새로운 128비트 체계로 2^128개의 주소를 갖는 인터넷 프로토콜 주소를 말한다.
2. IPv6 주소는 16비트 단위로 구분하며 각 단위는 16진수로 변환되어 클론(:)으로 구분하여 표기한다.
3. 128비트의 IPv6 주소에서 앞의 64비트는 네트워크 주소를 의미하고 뒤의 64비트는 네트워크에 연결된 통신장비 등에 할당되는 인터페이스 주소를 의미한다.

#### (나) IPv6의 장점
|구분|주요 내용|
|-|-|
|확대된 주소 공간|주소길이가 128비트로 증가하여 2^128개의 주소 사용 가능|
|단순해진 헤더 포맷|IPv4 주소 헤더의 불필요한 필드를 제거하여 보다 빠른 처리 가능|
|간편해진 주소 설정 기능|IPv6 프로토콜에 내장된 주소 자동 설정 기능을 이용하여 플러그 앤 플레이 설치가 가능|
|강화된 보안성|IPv6 주소에서는 IPsec 기능을 기본 사항으로 제공|
|개선된 모바일 IP|IPv6 주소 헤더에서 이동성 지원|

#### (다) IPv6 전환 기술
1. 듀얼스택(Dual Stack)
   * IPv4와 IPv6 프로토콜을 동시에 설정하여 통신 상대에 따라 선택적으로 사용할 수 있도록 하는 방식
   * 호스트, 라우터 등에 듀얼스택을 적용하여 IPv4와 IPv6 패킷을 모두 처리할 수 있도록 해준다. 장기적으로 보았을 때 가장 추천되는 방식이다.
2. 터널링(Tunneling)
   * IPv4 네트워크를 경유하여 IPv6 네트워크 간 통신을 위한 방식으로 IPv4 네트워크를 통과하는 가상의 경로를 만들어 통신하는 방식을 말한다.
   * 터널링 기술은 호스트와 라우터에서 IPv6 패킷을 IPv4 패킷으로 캡슐화하여 전송함으로써 캡슐화된 IPv6 패킷이 IPv4 네트워크를 통과하게 하는 기술이다.
3. 주소 변환(Address Translation) 또는 헤더(Header) 변환
   * 주소변환 방식은 IPv4 주소를 IPv6 주소로 변환하거나 IPv6 주소를 IPv4 주소로 변환하여 통신하는 방식을 말한다.
   * 패킷의 앞부분에 변환 헤더를 추가함으로써 주소를 변환하여 송신하고 수신측에서 변환 헤더를 제거하는 방식으로 통신한다.
   * 소수의 IPv6 사이트가 대규모의 IPv4 인터넷에 연결되는 전환의 초기 단계와 소수의 IPv4 사이트가 대규모의 IPv6 인터넷에 연결되는 전환의 마지막 단계에서 사용할 수 있다.
